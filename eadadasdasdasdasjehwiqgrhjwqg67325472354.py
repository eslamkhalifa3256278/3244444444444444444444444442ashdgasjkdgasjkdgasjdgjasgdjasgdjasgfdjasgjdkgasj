import streamlit as st
import google.generativeai as genai
from datetime import datetime, date
import hashlib
import time
from dateutil.relativedelta import relativedelta

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
LOGO_URL = "https://www2.0zz0.com/2025/05/01/22/992228290.png"
LOGIN_LOGO = "https://www2.0zz0.com/2025/05/01/22/314867624.png"

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ API Ù…Ù† Ø§Ù„Ù€ secrets
genai.configure(api_key=st.secrets["API_KEY"])
model = genai.GenerativeModel('gemini-2.0-flash')

# Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø¤Ù‚ØªØ©)
if 'users_db' not in st.session_state:
    st.session_state.users_db = {}

# Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
def app():
    st.set_page_config(
        page_title="LEO Chat",
        page_icon=LOGIN_LOGO,
        layout="wide",
        initial_sidebar_state="expanded"
    )

    # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    if "theme" not in st.session_state:
        st.session_state.theme = "light"

    if "messages" not in st.session_state:
        st.session_state.messages = []

    if "uploaded_files" not in st.session_state:
        st.session_state.uploaded_files = 0
        st.session_state.max_files_per_day = 2
        st.session_state.last_upload_date = None

    if "current_page" not in st.session_state:
        st.session_state.current_page = "login"

    if "logged_in" not in st.session_state:
        st.session_state.logged_in = False

    if "show_info" not in st.session_state:
        st.session_state.show_info = False

    def create_account():
        st.markdown(f"""
            <div style='text-align:center; margin-bottom: 20px;'>
                <img src="{LOGIN_LOGO}" width="300">
                <h2 style='color:#4B4B4B;'>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            </div>
            """, unsafe_allow_html=True)

        with st.form("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯"):
            name = st.text_input("ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„")
            email = st.text_input("ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
            birth_date = st.date_input("ğŸ‚ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯", min_value=date(1900, 1, 1))
            password = st.text_input("ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")
            confirm_password = st.text_input("âœ… ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")

            submitted = st.form_submit_button("Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ¨")
            if submitted:
                age = relativedelta(date.today(), birth_date).years
                if age < 18:
                    st.error("âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ù…Ø±Ùƒ 18 Ø¹Ø§Ù…Ø§Ù‹ Ø£Ùˆ Ø£ÙƒØ«Ø±")
                elif password != confirm_password:
                    st.error("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©")
                elif email in st.session_state.users_db:
                    st.error("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„")
                else:
                    st.session_state.users_db[email] = {
                        'name': name,
                        'password': hashlib.sha256(password.encode()).hexdigest(),
                        'birth_date': birth_date
                    }
                    st.success("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†")
                    time.sleep(2)
                    st.session_state.current_page = "login"
                    st.rerun()

    def login_page():
        st.markdown(f"""
            <div style='text-align:center; margin-bottom: 20px;'>
                <img src="{LOGIN_LOGO}" width="300">
                <h2 style='color:#4B4B4B;'>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            </div>
            """, unsafe_allow_html=True)

        with st.form("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"):
            email = st.text_input("ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
            password = st.text_input("ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password")

            submitted = st.form_submit_button("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…")
            if submitted:
                if email in st.session_state.users_db and \
                        hashlib.sha256(password.encode()).hexdigest() == st.session_state.users_db[email]['password']:
                    st.session_state.logged_in = True
                    st.session_state.current_user = {
                        'email': email,
                        'name': st.session_state.users_db[email]['name']
                    }
                    st.success("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!")
                    time.sleep(1)
                    st.rerun()
                else:
                    st.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©")

    def info_page():
        st.title("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚")
        st.markdown("""
        <div style="background-color:#f0f2f6;padding:20px;border-radius:10px">
            <h3>LEO Chat</h3>
            <p>ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙˆØ§Ø³Ø·Ø© <strong>Ø¥Ø³Ù„Ø§Ù… Ø®Ù„ÙŠÙØ©</strong></p>
            <p>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©: Ù…ØµØ±ÙŠ</p>
            <p>Ù„Ù„ØªÙˆØ§ØµÙ„: 01028799352</p>
            <p>Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 1.0</p>
        </div>
        """, unsafe_allow_html=True)

    if not st.session_state.logged_in:
        if st.session_state.current_page == "login":
            login_page()
            if st.button("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯"):
                st.session_state.current_page = "create_account"
                st.rerun()
        elif st.session_state.current_page == "create_account":
            create_account()
            if st.button("Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"):
                st.session_state.current_page = "login"
                st.rerun()
    else:
        # Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ / Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ
        theme_option = st.sidebar.selectbox("ğŸ¨ Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹", ["light", "dark"])
        st.session_state.theme = theme_option

        bg_color = "#0e1117" if theme_option == "dark" else "#FFFFFF"
        text_color = "#FAFAFA" if theme_option == "dark" else "#000000"

        with st.sidebar:
            st.image(LOGO_URL, width=200)
            st.markdown(f"### Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {st.session_state.current_user['name']}")
            st.markdown(f"**ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯:** {st.session_state.current_user['email']}")
            st.markdown(f"**ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ø§Ù„ÙŠÙˆÙ…:** {st.session_state.uploaded_files}/2")
            st.markdown(f"**ğŸ’¬ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:** {len(st.session_state.messages)}")
            if st.button("ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"):
                st.session_state.logged_in = False
                st.rerun()
            if st.button("ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©"):
                st.session_state.messages = []
                st.success("âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©")
                time.sleep(1)
                st.rerun()
            if st.button("â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"):
                st.session_state.show_info = True
                st.rerun()

        if st.session_state.show_info:
            info_page()
            if st.button("â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©"):
                st.session_state.show_info = False
                st.rerun()
        else:
            st.markdown(f"""
            <div style='background-color:{bg_color}; color:{text_color}; padding: 15px; border-radius: 10px;'>
                <h2 style='margin:0;'>LEO Chat ğŸ¤–</h2>
            </div>
            """, unsafe_allow_html=True)

            uploaded_file = st.file_uploader(
                "ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2 Ù…Ù„Ù ÙŠÙˆÙ…ÙŠØ§Ù‹)",
                type=["pdf", "txt", "docx"],
                accept_multiple_files=False
            )
            if uploaded_file:
                current_date = datetime.now().date()
                if st.session_state.last_upload_date != current_date:
                    st.session_state.uploaded_files = 0
                    st.session_state.last_upload_date = current_date

                if st.session_state.uploaded_files < st.session_state.max_files_per_day:
                    st.session_state.uploaded_files += 1
                    st.success("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­")
                else:
                    st.warning("âš ï¸ Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª")

            for message in st.session_state.messages:
                avatar = LOGIN_LOGO if message["role"] == "assistant" else "ğŸ‘¤"
                with st.chat_message(message["role"], avatar=avatar):
                    st.markdown(message["content"])

            prompt = st.chat_input("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...")
            if prompt:
                st.session_state.messages.append({"role": "user", "content": prompt})
                with st.spinner("Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø±Ø¯..."):
                    try:
                        response = model.generate_content(prompt)
                        reply = response.text
                        st.session_state.messages.append({"role": "assistant", "content": reply})
                        st.rerun()
                    except Exception as e:
                        st.error(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")

            st.markdown("""
            <hr style='border-top: 1px solid #ccc;'>
            <div style="text-align: center; font-size: 14px;">
                ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Eslam Khalifa | Ù†Ù…ÙˆØ°Ø¬ LEO AI 1.0
            </div>
            """, unsafe_allow_html=True)

if __name__ == "__main__":
    app()
