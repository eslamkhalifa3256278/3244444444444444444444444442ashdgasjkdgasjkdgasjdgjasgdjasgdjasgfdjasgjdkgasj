import streamlit as st
import google.generativeai as genai
from datetime import datetime, date
import hashlib
import time
from dateutil.relativedelta import relativedelta
import firebase_admin
from firebase_admin import credentials, firestore, auth
from firebase_admin.exceptions import FirebaseError
import re
import smtplib
from email.mime.text import MIMEText
import random
import string

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
LOGO_URL = "https://www2.0zz0.com/2025/04/26/20/375098708.png"
API_KEY = "AIzaSyAIW5XnFdDZn3sZ6uwRN05hX-KmKy0OaWw"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)
EMAIL_CONFIG = {
    'sender': 'your_email@example.com',
    'password': 'your_email_password',
    'smtp_server': 'smtp.example.com',
    'smtp_port': 587
}

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
genai.configure(api_key=API_KEY)
model = genai.GenerativeModel('gemini-2.0-flash')

# ØªÙ‡ÙŠØ¦Ø© Firebase
FIREBASE_CONFIG = {
    "apiKey": "AIzaSyBFYADCyytqgbSenbgIfOHxvP_4fV_Qais",
    "authDomain": "leoai-924b5.firebaseapp.com",
    "projectId": "leoai-924b5",
    "storageBucket": "leoai-924b5.firebasestorage.app",
    "messagingSenderId": "997032037109",
    "appId": "1:997032037109:web:25a701d30dffe9f8d2d3bc"
}

# Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„ØªÙƒÙˆÙŠÙ†
firebase_creds = {
    "type": "service_account",
    "project_id": FIREBASE_CONFIG["projectId"],
    "private_key_id": "YOUR_PRIVATE_KEY_ID",
    "private_key": "-----BEGIN PRIVATE KEY-----\nYOUR_PRIVATE_KEY\n-----END PRIVATE KEY-----\n",
    "client_email": f"firebase-adminsdk-abcdef@{FIREBASE_CONFIG['projectId']}.iam.gserviceaccount.com",
    "client_id": "123456789012345678901",
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token",
    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
    "client_x509_cert_url": f"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-abcdef%40{FIREBASE_CONFIG['projectId']}.iam.gserviceaccount.com"
}

try:
    if not firebase_admin._apps:
        cred = credentials.Certificate(firebase_creds)
        firebase_admin.initialize_app(cred)
    db = firestore.client()
    auth = auth
except Exception as e:
    st.error(f"ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase: {str(e)}")

# ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
def is_valid_email(email):
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(pattern, email) is not None

# ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
def send_password_reset_email(email, reset_token):
    try:
        reset_link = f"http://your-app-url.com/reset-password?token={reset_token}"
        message = f"""
        Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ
        
        Ù„Ù‚Ø¯ Ø·Ù„Ø¨Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ LEO Chat.
        Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:
        
        {reset_link}
        
        Ø¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„ØªØºÙŠÙŠØ±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.
        
        Ù…Ø¹ ØªØ­ÙŠØ§ØªØŒ
        ÙØ±ÙŠÙ‚ LEO Chat
        """
        
        msg = MIMEText(message)
        msg['Subject'] = 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± - LEO Chat'
        msg['From'] = EMAIL_CONFIG['sender']
        msg['To'] = email
        
        with smtplib.SMTP(EMAIL_CONFIG['smtp_server'], EMAIL_CONFIG['smtp_port']) as server:
            server.starttls()
            server.login(EMAIL_CONFIG['sender'], EMAIL_CONFIG['password'])
            server.sendmail(EMAIL_CONFIG['sender'], [email], msg.as_string())
        
        return True
    except Exception as e:
        st.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: {str(e)}")
        return False

# ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
def generate_reset_token():
    return ''.join(random.choices(string.ascii_letters + string.digits, k=32))

# Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
def app():
    st.set_page_config(
        page_title="LEO Chat",
        page_icon="https://www2.0zz0.com/2025/04/28/19/583882920.png",
        layout="wide",
        initial_sidebar_state="expanded"
    )

    # ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© "ØªØ°ÙƒØ±Ù†ÙŠ" Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
    if 'remember_me' not in st.session_state:
        st.session_state.remember_me = False

    # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
    if "uploaded_files" not in st.session_state:
        st.session_state.uploaded_files = 0
        st.session_state.max_files_per_day = 2
        st.session_state.last_upload_date = None
        st.session_state.uploaded_files_list = []

    # ØµÙØ­Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    def reset_password_page():
        st.title("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±")
        
        with st.form("reset_password_form"):
            email = st.text_input("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„")
            submit_button = st.form_submit_button("Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†")
            
            if submit_button:
                if not is_valid_email(email):
                    st.error("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­")
                else:
                    try:
                        user_ref = db.collection('users').document(email)
                        user_data = user_ref.get()
                        
                        if user_data.exists:
                            reset_token = generate_reset_token()
                            # Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                            user_ref.update({
                                'reset_token': reset_token,
                                'reset_token_expiry': datetime.now().timestamp() + 3600  # ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
                            })
                            
                            if send_password_reset_email(email, reset_token):
                                st.success("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
                                time.sleep(2)
                                st.session_state.current_page = "login"
                                st.rerun()
                        else:
                            st.error("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„")
                    except Exception as e:
                        st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")
        
        if st.button("Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"):
            st.session_state.current_page = "login"
            st.rerun()

    # ØµÙØ­Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ (Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    def create_account():
        col1, col2 = st.columns([1, 2])
        with col1:
            st.image(LOGO_URL, width=500)
        
        with col2:
            st.markdown("""
            <div style="background-color:#4169E1;padding:30px;border-radius:15px;box-shadow:0 4px 8px rgba(0,0,0,0.1)">
                <h2 style="color:#FFFFFF;text-align:center;margin-bottom:30px">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            """, unsafe_allow_html=True)
            
            with st.form("ğŸ˜Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯"):
                name = st.text_input("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„")
                email = st.text_input("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
                birth_date = st.date_input("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯", min_value=date(1900, 1, 1))
                password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password", placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ© (5 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)")
                confirm_password = st.text_input("ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password", placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±")
                
                submit_button = st.form_submit_button("Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨", type="primary")
                
                if submit_button:
                    age = relativedelta(date.today(), birth_date).years
                    if age < 18:
                        st.error("ğŸ¥ºÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ù…Ø±Ùƒ 18 Ø¹Ø§Ù…Ø§Ù‹ Ø£Ùˆ Ø£ÙƒØ«Ø±")
                    elif len(password) < 5:
                        st.error("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¹Ù„Ù‰ 5 Ø£Ø­Ø±Ù")
                    elif password != confirm_password:
                        st.error("ğŸ¤¦â€â™‚ï¸ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©")
                    elif not is_valid_email(email):
                        st.error("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­")
                    else:
                        try:
                            user_ref = db.collection('users').document(email)
                            if user_ref.get().exists:
                                st.error("ğŸ¤¦â€â™‚ï¸Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„")
                            else:
                                user_data = {
                                    'name': name,
                                    'password': hashlib.sha256(password.encode()).hexdigest(),
                                    'birth_date': birth_date.strftime('%Y-%m-%d'),
                                    'created_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                                }
                                user_ref.set(user_data)
                                st.success("â˜ºï¸ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†")
                                time.sleep(2)
                                st.session_state.current_page = "login"
                                st.rerun()
                        except Exception as e:
                            st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")
            
            st.markdown("""
            </div>
            <div style="text-align:center;margin-top:20px">
                <p style="color:#7f8c8d">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ</p>
            """, unsafe_allow_html=True)
            
            if st.button("Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", key="go_to_login"):
                st.session_state.current_page = "login"
                st.rerun()

    # ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    def login_page():
        col1, col2 = st.columns([1, 2])
        with col1:
            st.image(LOGO_URL, width=500)
        
        with col2:
            st.markdown("""
            <div style="background-color:#4169E1;padding:30px;border-radius:15px;box-shadow:0 4px 8px rgba(0,0,0,0.1)">
                <h2 style="color:#FFFFFF;text-align:center;margin-bottom:30px">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            """, unsafe_allow_html=True)
            
            with st.form("ğŸ˜‰ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"):
                email = st.text_input("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ")
                password = st.text_input("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", type="password", placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±")
                remember_me = st.checkbox("ØªØ°ÙƒØ±Ù†ÙŠ", value=st.session_state.remember_me)
                
                submit_button = st.form_submit_button("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", type="primary")
                
                if submit_button:
                    if not is_valid_email(email):
                        st.error("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­")
                    else:
                        try:
                            user_ref = db.collection('users').document(email)
                            user_data = user_ref.get()
                            
                            if user_data.exists and \
                                    hashlib.sha256(password.encode()).hexdigest() == user_data.to_dict().get('password'):
                                st.session_state.logged_in = True
                                st.session_state.current_user = {
                                    'email': email,
                                    'name': user_data.to_dict().get('name')
                                }
                                st.session_state.remember_me = remember_me
                                st.success("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!â˜ºï¸")
                                time.sleep(1)
                                st.rerun()
                            else:
                                st.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
                        except Exception as e:
                            st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")
            
            st.markdown("""
            </div>
            <div style="text-align:center;margin-top:20px">
                <p style="color:#7f8c8d">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ ÙŠØ§ ØµØ¯ÙŠÙ‚ÙŠ/Ø©!!</p>
            """, unsafe_allow_html=True)
            
            col1, col2 = st.columns(2)
            with col1:
                if st.button("Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", key="go_to_register"):
                    st.session_state.current_page = "create_account"
                    st.rerun()
            with col2:
                if st.button("Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ", key="forgot_password"):
                    st.session_state.current_page = "reset_password"
                    st.rerun()

    # ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    def info_page():
        st.title("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚")
        st.markdown("""
        <div style="background-color:#000000;padding:20px;border-radius:10px">
            <h3>LEO Chat</h3>
            <p>ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙˆØ§Ø³Ø·Ø© <strong>Ø¥Ø³Ù„Ø§Ù… Ø®Ù„ÙŠÙØ©</strong></p>
            <p>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©: Ù…ØµØ±ÙŠ</p>
            <p>Ù„Ù„ØªÙˆØ§ØµÙ„: 01028799352</p>
            <p>Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 1.0</p>
        </div>
        """, unsafe_allow_html=True)

    # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø§Øª
    if 'current_page' not in st.session_state:
        st.session_state.current_page = "login"

    # Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„
    if 'logged_in' in st.session_state and st.session_state.logged_in:
        with st.sidebar:
            st.image(LOGO_URL, width=200)
            st.markdown(f"### Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {st.session_state.current_user['name']}")
            st.markdown(f"**Ø§Ù„Ø¨Ø±ÙŠØ¯:** {st.session_state.current_user['email']}")

            if st.button("ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", type="primary", help="Ø§Ù†Ù‚Ø± Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"):
                st.session_state.logged_in = False
                st.session_state.remember_me = False
                st.rerun()

            st.markdown("---")

            if st.button("ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©"):
                st.session_state.messages = []
                st.rerun()

            st.markdown("---")
            st.subheader("Ø¢Ø®Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª")

            if "messages" not in st.session_state:
                st.session_state.messages = []

            if not st.session_state.messages:
                st.caption("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©")
            else:
                for i, msg in enumerate(reversed(st.session_state.messages[-5:])):
                    if msg["role"] == "user":
                        with st.container(border=True):
                            st.caption(f"Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© {len(st.session_state.messages[-5:]) - i}")
                            st.markdown(f"**{msg['content'][:30]}...**")

            st.markdown("---")
            if st.button("â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"):
                st.session_state.show_info = True
                st.rerun()

    # Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if 'logged_in' not in st.session_state or not st.session_state.logged_in:
        if st.session_state.current_page == "login":
            login_page()
        elif st.session_state.current_page == "create_account":
            create_account()
        elif st.session_state.current_page == "reset_password":
            reset_password_page()
    else:
        if 'show_info' in st.session_state and st.session_state.show_info:
            info_page()
            if st.button("Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"):
                st.session_state.show_info = False
                st.rerun()
        else:
            # Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            col1, col2 = st.columns([0.1, 0.9])
            with col1:
                st.image(LOGO_URL, width=80)
            with col2:
                st.title("LEO Chat")

            # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if "logged_in" in st.session_state and st.session_state.logged_in:
                # Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS Ù…Ø®ØµØµØ©
                st.markdown("""
                <style>
                    .file-upload-container {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin-bottom: 15px;
                    }
                    .file-upload-icon {
                        font-size: 28px;
                        color: #4169E1;
                    }
                    .file-preview-container {
                        display: flex;
                        gap: 8px;
                        margin-top: 5px;
                    }
                    .file-preview-item {
                        width: 32px;
                        height: 32px;
                        border-radius: 4px;
                        background-color: #f0f2f6;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                    }
                    .upload-btn {
                        flex-grow: 1;
                    }
                    .footer {
                        position: fixed;
                        bottom: 0;
                        width: 100%;
                        background-color: #f0f2f6;
                        padding: 10px;
                        text-align: center;
                        border-top: 1px solid #ddd;
                    }
                </style>
                """, unsafe_allow_html=True)

                # ØµÙ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª
                st.markdown('<div class="file-upload-container">', unsafe_allow_html=True)
                
                # Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
                st.markdown('<div class="file-upload-icon">ğŸ“</div>', unsafe_allow_html=True)
                
                # Ø²Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
                uploaded_file = st.file_uploader(
                    "Ø±ÙØ¹ Ù…Ù„Ù (Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2 Ù…Ù„Ù ÙŠÙˆÙ…ÙŠØ§Ù‹)",
                    type=["pdf", "txt", "docx", "png", "jpg", "jpeg"],
                    accept_multiple_files=False,
                    key="file_uploader",
                    label_visibility="collapsed"
                )
                
                st.markdown('</div>', unsafe_allow_html=True)

                # Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
                if st.session_state.uploaded_files_list:
                    st.markdown('<div class="file-preview-container">', unsafe_allow_html=True)
                    for file in st.session_state.uploaded_files_list[-2:]:  # Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ù…Ù„ÙÙŠÙ† ÙÙ‚Ø·
                        if file.type.startswith('image/'):
                            st.image(file, width=32)
                        else:
                            file_icon = "ğŸ“„" if file.type == "application/pdf" else \
                                        "ğŸ“" if file.type == "text/plain" else \
                                        "ğŸ“" if file.type == "application/vnd.openxmlformats-officedocument.wordprocessingml.document" else "ğŸ“"
                            st.markdown(f'<div class="file-preview-item">{file_icon}</div>', unsafe_allow_html=True)
                    st.markdown('</div>', unsafe_allow_html=True)

                if uploaded_file:
                    current_date = datetime.now().date()
                    if st.session_state.last_upload_date != current_date:
                        st.session_state.uploaded_files = 0
                        st.session_state.last_upload_date = current_date
                        st.session_state.uploaded_files_list = []

                    if st.session_state.uploaded_files < st.session_state.max_files_per_day:
                        st.session_state.uploaded_files += 1
                        st.session_state.uploaded_files_list.append(uploaded_file)
                        
                        # Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø©
                        file_icon = "ğŸ“„" if uploaded_file.type == "application/pdf" else \
                                    "ğŸ“" if uploaded_file.type == "text/plain" else \
                                    "ğŸ–¼ï¸" if uploaded_file.type.startswith("image/") else "ğŸ“"
                        
                        st.success(f"""
                        {file_icon} ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­: **{uploaded_file.name}**  
                        ({st.session_state.uploaded_files}/{st.session_state.max_files_per_day} - Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ)
                        """)
                    else:
                        st.warning("""
                        âš ï¸ Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª  
                        (2 Ù…Ù„Ù ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©)
                        """)

            # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            if "messages" not in st.session_state:
                st.session_state.messages = []

            for message in st.session_state.messages:
                avatar = "https://www2.0zz0.com/2025/04/28/19/583882920.png" if message["role"] == "assistant" else "ğŸ‘¤"
                with st.chat_message(message["role"], avatar=avatar):
                    st.markdown(message["content"])

            # Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
            if prompt := st.chat_input("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."):
                if "logged_in" not in st.session_state or not st.session_state.logged_in:
                    st.warning("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„")
                else:
                    # Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    st.session_state.messages.append({"role": "user", "content": prompt})

                    # ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø¯
                    with st.spinner("Ø¬Ø§Ø±Ù Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø¯..."):
                        try:
                            response = model.generate_content(prompt)
                            reply = response.text
                            st.session_state.messages.append({"role": "assistant", "content": reply})
                            st.rerun()
                        except Exception as e:
                            st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

            # ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„
            st.markdown("""
            <div style="margin-top: 50px; padding: 15px; background-color: #f0f2f6; border-radius: 8px; text-align: center;">
                <p style="margin: 0; font-size: 14px; color: #555;">
                    ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© <strong>Ø¥Ø³Ù„Ø§Ù… Ø®Ù„ÙŠÙØ©</strong> | Ù†Ù…ÙˆØ°Ø¬ <strong>Gemini</strong> 1.0
                </p>
            </div>
            """, unsafe_allow_html=True)


if __name__ == "__main__":
    app()
